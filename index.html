<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹åŠ›å‘ä¸Šã®ãŠéƒ¨å±‹</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css">
    <link rel="stylesheet" href="//cdn.rawgit.com/milligram/milligram/master/dist/milligram.min.css">
    
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
    <style>
        /* (CSS Styles are omitted for brevity, they should remain in style.css or your current file) */
        /* ... (ã“ã“ã«å…¨ã¦ã®CSSã‚¹ã‚¿ã‚¤ãƒ«ã‚’å«ã‚ã‚‹) ... */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .dashboard-item-card { background-color: #ffffff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); text-align: center; }
        .dashboard-item-card h4 { color: #5c6bc0; font-size: 1.2rem; margin-bottom: 10px; }
        .dashboard-value { font-weight: 700; color: #e91e63; font-size: 2.2rem; display: block; margin-top: 5px; }
        /* Lucky Meter Bar */
        /* â˜…å‰Šé™¤: Lucky Meter Bar ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤ */
        /* Calendar Placeholder */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { padding: 8px 0; border-radius: 5px; background-color: #f0f0f0; color: #666; font-size: 0.9em; }
        .calendar-day.today { background-color: #bbdefb; color: #3f51b5; font-weight: bold; }
        .calendar-day.has-record { background-color: #a5d6a7; color: #388e3c; font-weight: bold; }
        .calendar-day.weekend { color: #e91e63; }
        .calendar-header { font-weight: bold; color: #333; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        /* Menu items */
        .menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; }
        .menu-item { display: flex; align-items: center; padding: 20px; border-radius: 8px; text-decoration: none; color: #ffffff; font-weight: 600; font-size: 1.2rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .menu-item:hover { transform: translateY(-5px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); }
        .menu-item .icon { font-size: 2rem; margin-right: 15px; }
        .menu-item.blue { background-color: #2196f3; }
        .menu-item.dark { background-color: #555; }
        .menu-item.grey { background-color: #9e9e9e; }
        .menu-item.dark.grey { background-color: #607d8b; }
        .back-to-home { display: block; text-align: center; margin-top: 40px; padding: 10px 20px; border: 1px solid #ccc; border-radius: 5px; color: #666; text-decoration: none; transition: background-color 0.2s; }
        .back-to-home:hover { background-color: #f0f0f0; }
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: #000; text-decoration: none; cursor: pointer; }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ’˜ ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹åŠ›å‘ä¸Šã®ãŠéƒ¨å±‹ ğŸŒ’</h1>
            <p>äººç”Ÿã‚’ã‚ˆã‚Šå……å®Ÿã•ã›ã¦ã„ããŸã‚ã«å¿ƒã®ç­‹ãƒˆãƒ¬ã‚’è¡Œã„ã¾ã—ã‚‡ã†ğŸ¤©</p>
        </header>

        <div class="top-nav-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button id="howToUseButton" class="button-primary" style="background-color: #3498db; border-color: #3498db; font-size: 0.9rem;">
                ä½¿ã„æ–¹
            </button>
            <button id="logoutButton" class="button-primary" style="background-color: #e74c3c; border-color: #e74c3c; font-size: 0.9rem;">
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
        </div>

        <div id="howToUseModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h3>ä½¿ã„æ–¹ </h3>
                <p>ã“ã®ã‚¢ãƒ—ãƒªã§ã¯ã€ä¸»ã«ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã€æ—¥å¸¸ç”Ÿæ´»ã§ãƒã‚¬ãƒ†ã‚£ãƒ–ãªå ´é¢ã«é­é‡ã—ãŸéš›ã«æ€è€ƒã‚’ãƒã‚¸ãƒ†ã‚£ãƒ–ã«å¤‰ãˆã¦ã„ããŸã‚ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚</p>
                <h4> ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h4>
                <p>ã“ã®æ©Ÿèƒ½ã‚’ç”¨ã„ã¦ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚ã“ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç¹°ã‚Šè¿”ã™ã“ã¨ã§ã€ãƒã‚¬ãƒ†ã‚£ãƒ–ãªè€ƒãˆæ–¹ã®ã‚¯ã‚»ã‚’çŸ¯æ­£ã—ã€æœ€çµ‚çš„ã«å¿ƒã®å›å¾©åŠ›ï¼ˆãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ï¼‰ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚</p>
                <h4> è¨˜éŒ²ã®æŒ¯ã‚Šè¿”ã‚Š</h4>
                <p>éå»ã«è¡Œã£ãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²ã‚’ä¸€è¦§ã§ç¢ºèªã—ã€è¨˜éŒ²ã‚’æŒ¯ã‚Šè¿”ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
                <h4> æˆé•·å¯è¦–åŒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h4>
                <p>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸Šã§è¨˜éŒ²ã‚’ã—ãŸæ—¥ãŒé–²è¦§ã§ãã¾ã™ã€‚æ—¥ã€…ã®æˆé•·ã‚’è¦–è¦šçš„ã«ç¢ºèªã§ãã¾ã™ã€‚</p>
            </div>
        </div>

        <main class="main-content">
            <section class="dashboard-section">
                <h2>ğŸ“Š æˆé•·å¯è¦–åŒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                <div class="dashboard-grid">
                    
                    <div class="dashboard-item-card">
                        <h4>è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h4>
                        <div id="calendarNavContainer" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            </div>
                        <div class="calendar-grid" id="recordCalendar">
                            </div>
                        <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">ï¼ˆè¨˜éŒ²ã‚’è¡Œã£ãŸæ—¥ã‚’è¡¨ç¤ºï¼‰</p>
                    </div>

                    <div class="dashboard-item-card">
                        <h4>ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°å›æ•°</h4>
                        <span id="totalMindRecords" class="dashboard-value">0å›</span>
                        <p style="font-size: 0.8rem; color: #888; margin-top: 5px;"></p>
                    </div>
                    
                    </div>
            </section>

            <nav class="menu">
                <a href="mind-recorder.html" class="menu-item blue" style="padding: 30px; font-size: 1.6rem; font-weight: 700;">
                    <span class="icon">ğŸ§ </span>
                    ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°
                </a>
                <a href="view-records-unified.html" class="menu-item dark grey" style="padding: 30px; font-size: 1.6rem; font-weight: 700;">
                    <span class="icon">ğŸ“œ</span>
                    è¨˜éŒ²ã®æŒ¯ã‚Šè¿”ã‚Š
                </a>
            </nav>
        </main>
    </div>

    <script>
        // ------------------------------------
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
        // ------------------------------------
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('authToken'); // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
                localStorage.removeItem('currentUserId'); // IDã‚’å‰Šé™¤
                window.location.href = 'auth.html'; // èªè¨¼ç”»é¢ã¸æˆ»ã‚‹
            });
        }

// ------------------------------------
// â˜…â˜…â˜… ä¿®æ­£ç®‡æ‰€ï¼šæ—¥ä»˜ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ åŸºæº–ã§ YYYY-MM-DD ã«å¤‰æ›ã™ã‚‹é–¢æ•° â˜…â˜…â˜…
// ------------------------------------
function toYMD_Local(isoString) { // é–¢æ•°åã‚’ toYMD_Local ã«å¤‰æ›´ã—ã¦ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª toYMD ã¨åŒºåˆ¥
    if (!isoString) return null;

    // ISOæ–‡å­—åˆ—ã‹ã‚‰Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
    const dateObj = new Date(isoString);

    // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€å¹´/æœˆ/æ—¥ã‚’å–å¾—
    const year = dateObj.getFullYear();
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const day = String(dateObj.getDate()).padStart(2, '0');
    
    return `${year}-${month}-${day}`;
}
        
        // ------------------------------------
        // DOMContentLoaded ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ async ã«å¤‰æ›´ã—ã€å…¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ±åˆ
        // ------------------------------------
        document.addEventListener('DOMContentLoaded', async () => { 

            // â˜…â˜…â˜… èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’æœ€åˆã«å®Ÿè¡Œã—ã€ç„¡åŠ¹ãªå ´åˆã¯å³åº§ã«ä¸­æ–­ â˜…â˜…â˜…
            const authToken = localStorage.getItem('authToken'); 
            if (!authToken) {
                // ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ãŒåˆ¥é€”å‹•ããŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„ã€‚
                // ãŸã ã—ã€å¿µã®ãŸã‚window.location.href = 'auth.html'; ã¯æ®‹ã™ã€‚
                window.location.href = 'auth.html';
                return; // ã“ã“ã§å‡¦ç†ã‚’ä¸­æ–­
            }

            // ------------------------------------
            // å…±é€šã®å®šæ•°ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
            // ------------------------------------
            // â˜…å‰Šé™¤: æ€è€ƒè©•ä¾¡ãƒã‚¤ãƒ³ãƒˆã‚’å‰Šé™¤
            const intensityPoints = { 'low': 0, 'medium': 1, 'high': 2 };
            // â˜…å‰Šé™¤: çŒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¸å®šç¾©ã‚’å‰Šé™¤

            const toYMD = (isoString) => toYMD_Local(isoString); // â˜…ã“ã®è¡Œã‚’æ–°ãŸã«è¿½åŠ /ä¿®æ­£â˜…
            const isConsecutive = (date1, date2) => {
                const d1 = new Date(date1);
                const d2 = new Date(date2);
                const oneDay = 24 * 60 * 60 * 1000;
                const diff = Math.abs(d1.setUTCHours(0, 0, 0, 0) - d2.setUTCHours(0, 0, 0, 0));
                return diff === oneDay;
            };
            
            // ------------------------------------
            // ç”»é¢é·ç§»é–¢æ•°
            // ------------------------------------
            function goToRecordsByDate(isoDate) {
                localStorage.setItem('filterDate', isoDate);
                window.location.href = 'view-records-unified.html';
            }

            // ------------------------------------
            // è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢æ•° (ç¾çŠ¶ã®æœˆè¡¨ç¤ºã®ã¿)
            // ------------------------------------
            function generateRecordCalendar(allRecords) {
                const recordCalendarElement = document.getElementById('recordCalendar');
                if (!recordCalendarElement) return;

                recordCalendarElement.innerHTML = '';
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const recordDates = new Set();
                allRecords.forEach(r => {
                    const dateSource = r.date;
                    if (dateSource) { 
                        // YYYY-MM-DD å½¢å¼ã®æ–‡å­—åˆ—ã‚’ã‚»ãƒƒãƒˆã«æ ¼ç´
                        recordDates.add(toYMD(dateSource));
                    }
                });
                // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æç”»
                const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                weekdays.forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'calendar-day calendar-header';
                    header.textContent = day;
                    recordCalendarElement.appendChild(header);
                });

                const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
                const startingDay = firstDayOfMonth.getDay();
                for (let i = 0; i < startingDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day';
                    recordCalendarElement.appendChild(emptyDay);
                }

                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    dayElement.textContent = i;

                    const dateToCheck = new Date(currentYear, currentMonth, i);
                    const dateString = dateToCheck.toDateString();
                    const isoDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    
                    if (dateString === today.toDateString()) {
                        dayElement.classList.add('today');
                    }
                    
                    if (recordDates.has(isoDate)) {
                        dayElement.classList.add('has-record');
                        dayElement.classList.add('clickable-date');
                        dayElement.dataset.isoDate = isoDate;
                        dayElement.addEventListener('click', () => {
                            goToRecordsByDate(isoDate);
                        });
                    }
                    
                    if (dateToCheck.getDay() === 0 || dateToCheck.getDay() === 6) { 
                        dayElement.classList.add('weekend');
                    }
                    
                    recordCalendarElement.appendChild(dayElement);
                }
            }
            
            // ------------------------------------
            // ãƒ¡ã‚¤ãƒ³å‡¦ç† (updateDashboard)
            // ------------------------------------
            async function updateDashboard() { 
                // â˜… getRecords() ã¯ script.js ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                const allUserRecords = await getRecords(); 

                const mindRecords = allUserRecords.filter(r => r.type === 'mindRecord');
                const positiveRecords = allUserRecords.filter(r => r.type === 'positive');
                const meditationRecords = allUserRecords.filter(r => r.type === 'meditation');
                
                let totalScore = 0;
                
                // --- 1. ãƒã‚¸ãƒ†ã‚£ãƒ–æ—¥è¨˜ã®ã‚¹ã‚³ã‚¢è¨ˆç®— --- (å‡¦ç†ã¯æ®‹ã™ãŒã€ã‚¹ã‚³ã‚¢ã¯åˆ©ç”¨ã—ãªã„)
                const positiveDays = {}; 
                positiveRecords.forEach(r => {
                    const dateKey = toYMD(r.date);
                    if (!positiveDays[dateKey]) { positiveDays[dateKey] = { base: 0, bonus: 0, intensity: 0, rawRecords: [] }; }
                    positiveDays[dateKey].rawRecords.push(r);
                });

                const sortedDates = Object.keys(positiveDays).sort();
                let consecutiveDays = 0;
                let lastDate = null;
                
                for (const dateKey of sortedDates) {
                    const records = positiveDays[dateKey];
                    records.base = 5;
                    const maxIntensity = records.rawRecords.reduce((max, r) => 
                        Math.max(max, intensityPoints[r.intensity] || 0), 0);
                    records.intensity = maxIntensity; 
                    
                    if (lastDate && isConsecutive(lastDate, dateKey)) {
                        consecutiveDays++;
                        records.bonus = 2; 
                    } else {
                        consecutiveDays = 0;
                    }
                    lastDate = dateKey;
                    // totalScore += records.base + records.intensity + records.bonus; // â˜…å‰Šé™¤: ã‚¹ã‚³ã‚¢åŠ ç®—
                }
                
                // --- 2. ç·ç‘æƒ³æ™‚é–“ã®ã‚¹ã‚³ã‚¢è¨ˆç®— ---
                let totalSeconds = meditationRecords.reduce((sum, r) => sum + (r.duration || 0), 0);
                // totalScore += Math.floor(totalSeconds / 120); // â˜…å‰Šé™¤: ã‚¹ã‚³ã‚¢åŠ ç®—

                // --- 3. æ€è€ƒå¤‰æ›ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ã‚¹ã‚³ã‚¢è¨ˆç®— ---
                const mindDays = new Set();
                mindRecords.forEach(r => {
                    const dateKey = toYMD(r.date);
                    if (mindDays.has(dateKey)) { return; }

                    let dayScore = 7;
                    // const assessmentKey = r.thoughtAssessment; // â˜…å‰Šé™¤: thoughtAssessmentã®åˆ©ç”¨
                    // const assessmentScore = thoughtAssessmentPoints[assessmentKey] || 0; // â˜…å‰Šé™¤: è©•ä¾¡ã‚¹ã‚³ã‚¢ã®è¨ˆç®—
                    // dayScore += assessmentScore;
                    
                    // totalScore += dayScore; // â˜…å‰Šé™¤: ã‚¹ã‚³ã‚¢åŠ ç®—
                    mindDays.add(dateKey);
                });

                // --- 4. å¹¸ç¦æ‹›ãçŒ«ã®ç”»åƒæ›´æ–° ---
                // â˜…å‰Šé™¤: é–¢é€£ã™ã‚‹DOMæ“ä½œãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤
                
                // --- 5. ãã®ä»–ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åæ˜  ---
                const totalMindRecords = mindRecords.length;
                document.getElementById('totalMindRecords').textContent = `${totalMindRecords}å›`;

                // è¨˜éŒ²ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æç”»
                generateRecordCalendar(allUserRecords); 

            // ------------------------------------
            // ä½¿ã„æ–¹ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
            // ------------------------------------
            const howToUseButton = document.getElementById('howToUseButton');
            const howToUseModal = document.getElementById('howToUseModal');
            const closeButton = howToUseModal.querySelector('.close-button');

            if (howToUseButton && howToUseModal) {
                howToUseButton.addEventListener('click', () => {
                    howToUseModal.style.display = 'block';
                });
                closeButton.addEventListener('click', () => {
                    howToUseModal.style.display = 'none';
                });
                window.addEventListener('click', (event) => {
                    if (event.target == howToUseModal) {
                        howToUseModal.style.display = 'none';
                    }
                });
            }


            } // end of updateDashboard

            // ä»¥å‰ã®ãƒ­ã‚¸ãƒƒã‚¯: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®æ›´æ–°ã«é€²ã‚€
            await updateDashboard();

        });
        
    </script>
</body>
</html>